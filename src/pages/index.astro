---
import BaseLayout from "../layouts/BaseLayout.astro";
import {
  interventions,
  getSessionsWithStats,
  getRegidorsWithStats,
  polEmoji,
  polClass,
  polLabel,
  partyClass,
} from "../lib/data";

const sessionsStats = getSessionsWithStats();
const regidorsStats = getRegidorsWithStats();

const totalInterventions = interventions.length;
const totalSessions = sessionsStats.length;
const totalRegidors = regidorsStats.filter(
  (r) => r.interventionCount > 0,
).length;
const parties = [
  ...new Set(interventions.map((i) => i.speaker_party).filter(Boolean)),
];

// Últimes 4 sessions (grid-2 simètric)
const latestSessions = sessionsStats.slice(0, 4);

// Polarització global
const polDist = [1, 2, 3, 4].map((level) => ({
  level,
  count: interventions.filter((i) => i.polarization === level).length,
  emoji: polEmoji(level),
  label: polLabel(level),
}));
---

<BaseLayout title="Inici">
  <!-- Hero -->
  <section class="hero">
    <div class="hero__content">
      <p class="hero__eyebrow">Consell Municipal de Barcelona</p>
      <h1 class="hero__title">
        Les paraules dels regidors,<br class="hero__br" /> analitzades i en obert.
      </h1>
      <p class="hero__subtitle">
        Cada intervenció, cada debat i cada posició política dels plens
        municipals: transcrita, indexada i analitzada amb indicadors de retòrica
        i polarització.
      </p>
      <div class="hero__actions">
        <a href={`${import.meta.env.BASE_URL}sessions/`} class="btn btn--primary"
          >Explorar sessions</a
        >
        <a href={`${import.meta.env.BASE_URL}about/`} class="btn btn--ghost"
          >Com funciona →</a
        >
      </div>
    </div>
    <div class="hero__proof">
      <div class="hero__proof-item">
        <strong class="hero__proof-value"
          >{totalInterventions.toLocaleString("ca-ES")}</strong
        >
        <span class="hero__proof-label">intervencions</span>
      </div>
      <div class="hero__proof-divider" aria-hidden="true"></div>
      <div class="hero__proof-item">
        <strong class="hero__proof-value">{totalSessions}</strong>
        <span class="hero__proof-label">sessions analitzades</span>
      </div>
      <div class="hero__proof-divider" aria-hidden="true"></div>
      <div class="hero__proof-item">
        <strong class="hero__proof-value">{totalRegidors}</strong>
        <span class="hero__proof-label">regidors indexats</span>
      </div>
      <div class="hero__proof-divider" aria-hidden="true"></div>
      <div class="hero__proof-item">
        <strong class="hero__proof-value">{parties.length}</strong>
        <span class="hero__proof-label">partits representats</span>
      </div>
    </div>
  </section>

  <!-- Últimes sessions -->
  <section class="section">
    <div class="section__header">
      <h2 class="section__title">Últimes sessions</h2>
      <a
        href={`${import.meta.env.BASE_URL}sessions/`}
        class="section__link"
      >
        Veure-les totes →
      </a>
    </div>
    <div class="grid grid-2">
      {
        latestSessions.map((s) => (
          <a
            href={`${import.meta.env.BASE_URL}sessions/${s.sessionId}/`}
            class="card session-card"
          >
            <div class="session-card__date">{s.date}</div>
            <div class="session-card__title">{s.title}</div>
            <div class="session-card__meta">
              <span class="badge badge--tag">
                {s.interventionCount} intervencions
              </span>
              <span class="badge badge--tag">{s.agendaItemCount} punts</span>
              {s.avgPolarization > 0 && (
                <span class={`badge ${polClass(s.avgPolarization)}`}>
                  {polEmoji(s.avgPolarization)} {polLabel(s.avgPolarization)}
                </span>
              )}
              {s.hasHateSpeech && (
                <span class="badge badge--hate">⚠️ Discurs d'odi</span>
              )}
            </div>
          </a>
        ))
      }
    </div>
  </section>

  <!-- Polarització -->
  <section class="section">
    <div class="section__header">
      <h2 class="section__title">Polarització al ple</h2>
      <a
        href={`${import.meta.env.BASE_URL}retorica/`}
        class="section__link"
      >
        Anàlisi retòrica →
      </a>
    </div>
    <p class="section__description">
      Cada intervenció rep una puntuació de l'1 al 4, des del consens total
      fins al debat molt intens. L'escala mesura el grau de conflicte o
      acord en el discurs.
    </p>
    <div class="pol-bars">
      {
        polDist.map((p) => {
          const pct =
            totalInterventions > 0
              ? Math.round((p.count / totalInterventions) * 100)
              : 0;
          return (
            <div class="pol-bar">
              <div class="pol-bar__label">
                {p.emoji} {p.label}
              </div>
              <div class="pol-bar__track">
                <div
                  class={`pol-bar__fill pol-bar__fill--${p.level}`}
                  style={`width: ${pct}%`}
                />
              </div>
              <div class="pol-bar__value">
                {p.count.toLocaleString("ca-ES")} ({pct}%)
              </div>
            </div>
          );
        })
      }
    </div>
  </section>

  <!-- Top regidors -->
  <section class="section">
    <div class="section__header">
      <h2 class="section__title">Regidors més actius</h2>
      <a href={`${import.meta.env.BASE_URL}regidors/`} class="section__link">
        Veure tots →
      </a>
    </div>
    <div class="grid grid-4">
      {
        regidorsStats.slice(0, 8).map((r) => (
          <a
            href={`${import.meta.env.BASE_URL}regidors/${r.slug}/`}
            class="card regidor-mini"
          >
            <img
              src={r.photo}
              alt={r.name}
              class="regidor-mini__photo"
              loading="lazy"
            />
            <div class="regidor-mini__name">{r.name}</div>
            <span class={`badge ${partyClass(r.party)}`}>{r.party}</span>
            <div class="regidor-mini__count">
              {r.interventionCount} intervencions
            </div>
          </a>
        ))
      }
    </div>
  </section>
</BaseLayout>

<style>
  /* Hero */
  .hero {
    padding: var(--s-3xl) 0 var(--s-2xl);
    border-bottom: 1px solid var(--c-border-light);
    margin-bottom: 0;
  }

  .hero__content {
    max-width: 720px;
    margin-bottom: var(--s-2xl);
  }

  .hero__eyebrow {
    font-size: var(--fs-sm);
    font-weight: 600;
    color: var(--c-accent);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    margin-bottom: var(--s-md);
  }

  .hero__title {
    font-size: clamp(2rem, 5vw, 3.25rem);
    font-weight: 700;
    line-height: 1.15;
    color: var(--c-text);
    margin-bottom: var(--s-lg);
    letter-spacing: -0.02em;
  }

  .hero__subtitle {
    font-size: var(--fs-lg);
    color: var(--c-text-muted);
    line-height: 1.65;
    max-width: 600px;
    margin-bottom: var(--s-xl);
  }

  .hero__actions {
    display: flex;
    gap: var(--s-sm);
    flex-wrap: wrap;
  }

  /* Stats proof row */
  .hero__proof {
    display: flex;
    align-items: center;
    gap: var(--s-xl);
    flex-wrap: wrap;
    padding: var(--s-lg) var(--s-xl);
    background: var(--c-bg-alt);
    border-radius: var(--radius-lg);
    border: 1px solid var(--c-border);
  }

  .hero__proof-item {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .hero__proof-value {
    font-size: var(--fs-2xl);
    font-weight: 700;
    color: var(--c-text);
    line-height: 1.1;
    font-variant-numeric: tabular-nums;
  }

  .hero__proof-label {
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    font-weight: 500;
  }

  .hero__proof-divider {
    width: 1px;
    height: 2.5rem;
    background: var(--c-border);
    flex-shrink: 0;
  }

  /* Session cards */
  .session-card__date {
    font-size: var(--fs-xs);
    font-weight: 700;
    color: var(--c-accent);
    letter-spacing: 0.03em;
    text-transform: uppercase;
    margin-bottom: var(--s-xs);
  }
  .session-card__title {
    font-weight: 600;
    margin-bottom: var(--s-sm);
    line-height: 1.4;
  }
  .session-card__meta {
    display: flex;
    gap: var(--s-xs);
    flex-wrap: wrap;
  }

  /* Polarization chart */
  .pol-bars {
    display: flex;
    flex-direction: column;
    gap: var(--s-md);
    max-width: 640px;
  }
  .pol-bar {
    display: grid;
    grid-template-columns: 180px 1fr 110px;
    align-items: center;
    gap: var(--s-md);
  }
  .pol-bar__label {
    font-size: var(--fs-sm);
    font-weight: 500;
  }
  .pol-bar__track {
    height: 20px;
    background: var(--c-bg-alt);
    border-radius: 99px;
    overflow: hidden;
  }
  .pol-bar__fill {
    height: 100%;
    border-radius: 99px;
  }
  .pol-bar__fill--1 { background: var(--c-pol-1); }
  .pol-bar__fill--2 { background: var(--c-pol-2); }
  .pol-bar__fill--3 { background: var(--c-pol-3); }
  .pol-bar__fill--4 { background: var(--c-pol-4); }
  .pol-bar__value {
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    text-align: right;
    font-variant-numeric: tabular-nums;
  }

  /* Regidor mini cards */
  .regidor-mini {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--s-xs);
  }
  .regidor-mini__photo {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--c-border);
    margin-bottom: 2px;
  }
  .regidor-mini__name {
    font-weight: 600;
    font-size: var(--fs-sm);
    line-height: 1.3;
  }
  .regidor-mini__count {
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero {
      padding: var(--s-2xl) 0 var(--s-xl);
    }
    .hero__br {
      display: none;
    }
    .hero__proof {
      gap: var(--s-lg);
      padding: var(--s-md) var(--s-lg);
    }
    .hero__proof-divider {
      display: none;
    }
    .hero__proof-item {
      min-width: calc(50% - var(--s-lg));
    }
    .pol-bar {
      grid-template-columns: 1fr;
      gap: var(--s-xs);
    }
    .pol-bar__value {
      text-align: left;
    }
  }
</style>
