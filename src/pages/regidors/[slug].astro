---
import BaseLayout from "../../layouts/BaseLayout.astro";
import {
  regidors,
  slugify,
  getInterventionsBySpeaker,
  partyClass,
  polEmoji,
  polClass,
  findSession,
  youtubeTimestamp,
  generateSessionId,
  getInterventionAnchor,
} from "../../lib/data";

export function getStaticPaths() {
  return regidors.map((r) => ({
    params: { slug: slugify(r.name) },
    props: { regidor: r },
  }));
}

const { slug } = Astro.params;
const { regidor } = Astro.props;
const myInterventions = getInterventionsBySpeaker(regidor.name);
const mySessions = [...new Set(myInterventions.map((i) => i.session_id))];

// Temes m√©s freq√ºents
const tagCount: Record<string, { name: string; count: number }> = {};
myInterventions.forEach((i) => {
  (i.tags || []).forEach((t) => {
    if (!tagCount[t.code]) tagCount[t.code] = { name: t.name, count: 0 };
    tagCount[t.code].count++;
  });
});
const topTags = Object.entries(tagCount)
  .sort(([, a], [, b]) => b.count - a.count)
  .slice(0, 5);

// Polaritzaci√≥ mitja
const polValues = myInterventions
  .filter((i) => i.polarization)
  .map((i) => i.polarization!);
const avgPol =
  polValues.length > 0
    ? +(polValues.reduce((a, b) => a + b, 0) / polValues.length).toFixed(1)
    : 0;
---

<BaseLayout title={regidor.name}>
  <nav class="breadcrumb" aria-label="breadcrumb">
    <li><a href={import.meta.env.BASE_URL}>Inici</a></li>
    <li><a href={`${import.meta.env.BASE_URL}regidors/`}>Regidors</a></li>
    <li>{regidor.name}</li>
  </nav>

  <div class="regidor-profile">
    <img
      src={regidor.photo}
      alt={regidor.name}
      class="regidor-profile__photo"
    />
    <div class="regidor-profile__info">
      <h1 class="regidor-profile__name">{regidor.name}</h1>
      <div class="regidor-profile__meta">
        <span class={`badge ${partyClass(regidor.party)}`}>{regidor.party}</span
        >
        {
          regidor.salary && (
            <span class="badge badge--tag">üí∞ {regidor.salary}</span>
          )
        }
      </div>
      <p class="regidor-profile__dedication">{regidor.dedication}</p>

      <div class="regidor-profile__links">
        {
          regidor.social_media &&
            Object.entries(regidor.social_media).map(([network, url]) => (
              <a
                href={url as string}
                target="_blank"
                rel="noopener"
                class="badge badge--tag"
              >
                {network}
              </a>
            ))
        }
        {
          regidor.links?.cv && (
            <a
              href={regidor.links.cv}
              target="_blank"
              rel="noopener"
              class="badge badge--tag"
            >
              üìÑ CV
            </a>
          )
        }
      </div>
    </div>
  </div>

  <!-- Estad√≠stiques -->
  <section class="section">
    <div class="stats">
      <div class="stat">
        <div class="stat__value">{myInterventions.length}</div>
        <div class="stat__label">Intervencions</div>
      </div>
      <div class="stat">
        <div class="stat__value">{mySessions.length}</div>
        <div class="stat__label">Sessions</div>
      </div>
      <div class="stat">
        <div class="stat__value">{avgPol > 0 ? avgPol : "‚Äî"}</div>
        <div class="stat__label">Polaritzaci√≥ mitj.</div>
      </div>
    </div>
  </section>

  <!-- Temes -->
  {
    topTags.length > 0 && (
      <section class="section">
        <h2 class="section__title">üè∑Ô∏è Temes principals</h2>
        <div style="display:flex; gap: var(--s-sm); flex-wrap: wrap;">
          {topTags.map(([code, tag]) => (
            <a
              href={`${import.meta.env.BASE_URL}temes/${code}/`}
              class="badge badge--tag"
            >
              {tag.name} ({tag.count})
            </a>
          ))}
        </div>
      </section>
    )
  }

  <!-- Intervencions -->
  <section class="section">
    <h2 class="section__title">üé§ Intervencions ({myInterventions.length})</h2>
    <div class="interventions-list">
      {
        myInterventions.slice(0, 100).map((i) => {
          const session = findSession(i.session_id);
          return (
            <div class="intervention-item" data-pagefind-body>
              <div class="intervention-item__header">
                <a
                  href={`${import.meta.env.BASE_URL}sessions/${i.session_id}/#${getInterventionAnchor(i)}`}
                  class="intervention-item__session"
                >
                  üìÖ {i.session_date} ‚Äî {i.session_title}
                </a>
                {i.agenda_item_title && (
                  <span class="intervention-item__agenda">
                    üìã {i.agenda_item_number}: {i.agenda_item_title}
                  </span>
                )}
                <div class="intervention-item__meta">
                  {session && (
                    <a
                      href={youtubeTimestamp(
                        session.video_url,
                        i.start_seconds,
                      )}
                      target="_blank"
                      rel="noopener"
                      class="intervention__time"
                    >
                      üïê {i.start_time}
                    </a>
                  )}
                  {i.polarization && (
                    <span class={`badge ${polClass(i.polarization)}`}>
                      {polEmoji(i.polarization)}
                    </span>
                  )}
                </div>
              </div>
              <p class="intervention__text">{i.text}</p>
            </div>
          );
        })
      }
      {
        myInterventions.length > 100 && (
          <p
            class="text-muted"
            style="text-align:center; padding: var(--s-lg);"
          >
            Mostrant les 100 primeres de {myInterventions.length} intervencions.
          </p>
        )
      }
    </div>
  </section>
</BaseLayout>

<style>
  .regidor-profile {
    display: flex;
    gap: var(--s-xl);
    padding: var(--s-xl) 0;
    border-bottom: 2px solid var(--c-accent);
    margin-bottom: var(--s-lg);
  }
  .regidor-profile__photo {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid var(--c-border);
    flex-shrink: 0;
  }
  .regidor-profile__name {
    font-size: var(--fs-3xl);
    margin-bottom: var(--s-sm);
  }
  .regidor-profile__meta {
    display: flex;
    gap: var(--s-sm);
    flex-wrap: wrap;
    margin-bottom: var(--s-sm);
  }
  .regidor-profile__dedication {
    font-size: var(--fs-sm);
    color: var(--c-text-muted);
    margin-bottom: var(--s-sm);
  }
  .regidor-profile__links {
    display: flex;
    gap: var(--s-xs);
    flex-wrap: wrap;
  }

  .interventions-list {
    display: flex;
    flex-direction: column;
    gap: var(--s-md);
  }
  .intervention-item {
    padding: var(--s-md);
    background: var(--c-bg-alt);
    border-radius: var(--radius);
    border-left: 3px solid var(--c-border);
  }
  .intervention-item__header {
    margin-bottom: var(--s-sm);
  }
  .intervention-item__session {
    font-weight: 600;
    font-size: var(--fs-sm);
    display: block;
    margin-bottom: var(--s-xs);
  }
  .intervention-item__agenda {
    font-size: var(--fs-xs);
    color: var(--c-text-muted);
    display: block;
    margin-bottom: var(--s-xs);
  }
  .intervention-item__meta {
    display: flex;
    gap: var(--s-sm);
    align-items: center;
  }

  @media (max-width: 768px) {
    .regidor-profile {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    .regidor-profile__photo {
      width: 100px;
      height: 100px;
    }
  }
</style>
